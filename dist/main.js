(()=>{"use strict";var e,t,i,o={5425:(e,t,i)=>{i.r(t)},7708:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EActions=void 0,function(e){e[e.Continue=0]="Continue",e[e.Exit=1]="Exit",e[e.Play=2]="Play"}(t.EActions||(t.EActions={}))},5848:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.beforeFrameHandler=void 0;const o=i(370),s=i(8415);function a(e){const t=.001*performance.now();let i=Math.floor(t),o=Math.floor(t%1*1e9);return e&&(i-=e[0],o-=e[1],o<0&&(i--,o+=1e9)),[i,o]}let r=a(),n=0;t.beforeFrameHandler=async function(e){var t;const i=e.getResource(o.GameStore);var c;(null===(t=i.currentState)||void 0===t?void 0:t.constructor)==s.PauseState||(i.lastFrameDeltaTime=(c=a(r))[0]+1e-9*c[1],i.lastFrameDeltaTime>.1&&(i.lastFrameDeltaTime=.1),i.timeSinceLevelLoaded+=i.lastFrameDeltaTime,n+=i.lastFrameDeltaTime,i.medianFps=++i.ticks/n,r=a());const h=e.getResource(CanvasRenderingContext2D);h.beginPath(),h.fillStyle="#000",h.fillRect(0,0,h.canvas.width,h.canvas.height)}},1758:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.save=t.load=void 0;const o=i(5038),s=i(3214),a="save";t.load=function(e){const t=localStorage.getItem(a);if(!t)throw new Error("No save available. Cannot load!");return e.commands.load(o.SerialFormat.fromJSON(t))},t.save=function(e){localStorage.setItem(a,e.save(new o.Query([o.WithTag(s.ETags.save)])).toJSON())}},7276:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.lerp=t.PIXELS_PER_METER=t.drawPoint=t.TWOPI=void 0,t.TWOPI=2*Math.PI;t.drawPoint=(e,i,o,s=.1)=>{e.beginPath(),e.fillStyle="rgba(255,255,255,0.7)",e.arc(i,o,s,0,t.TWOPI),e.fill()},t.PIXELS_PER_METER=32;t.lerp=(e,t,i)=>e+(t-e)*(i=(i=i<0?0:i)>1?1:i)},8961:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Character=void 0;t.Character=class{constructor(e=""){this.name=e}}},7947:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Collision=void 0;t.Collision=class{constructor(e=!0,t=null){if(this.shapeFromVisuals=e,this.shape=t,this.collisionObjects=new Set,this.occurred=!1,!e&&!t)throw new Error("Either copy the collision shape                from visuals or provide a new one")}}},7981:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Material=void 0;t.Material=class{constructor(e){this.color=e}}},2019:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Mesh=void 0;t.Mesh=class{constructor(e){this.verticies=e,this.isConvex=!0}}},1979:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PhysicsBridge=void 0;t.PhysicsBridge=class{constructor(e=null){this.bodyPtr=e}}},7676:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Position=void 0;const o=i(7531);class s extends o.Vector2D{}t.Position=s},2591:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Rotation=void 0;t.Rotation=class{constructor(e){this.value=e}}},2958:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Shape=t.ShapePivotNames=t.ShapePivot=t.ShapePrimitive=void 0;const o=i(2189),s=i(7531);var a,r;!function(e){e.Circle="circle",e.Rect="rect",e.Mesh="mesh"}(a=t.ShapePrimitive||(t.ShapePrimitive={})),function(e){e[e.TopLeft=0]="TopLeft",e[e.TopMiddle=1]="TopMiddle",e[e.TopRight=2]="TopRight",e[e.Left=3]="Left",e[e.Middle=4]="Middle",e[e.Right=5]="Right",e[e.BottomLeft=6]="BottomLeft",e[e.BottomMiddle=7]="BottomMiddle",e[e.BottomRight=8]="BottomRight"}(r=t.ShapePivot||(t.ShapePivot={})),t.ShapePivotNames={[r.TopLeft]:"TopLeft",[r.TopMiddle]:"TopMiddle",[r.TopRight]:"TopRight",[r.Left]:"Left",[r.Middle]:"Middle",[r.Right]:"Right",[r.BottomLeft]:"BottomLeft",[r.BottomMiddle]:"BottomMiddle",[r.BottomRight]:"BottomRight"};t.Shape=class{constructor(e=0,t=r.Middle,i=0,n=0,c=s.vecZero,h=a.Rect,l=null){this.zIndex=e,this.pivot=t,this.offsetX=i,this.offsetY=n,this.dimensions=c,this.primitive=h,this.mesh=l,this.bBox=new o.Rect(0,0,0,0),this.isBuilt=!1}build(){if(this.isBuilt)return;if(this.primitive===a.Mesh&&!this.mesh)throw new Error("Shapes with mesh primitive                must provide a mesh data");if(this.primitive!==a.Mesh&&!this.dimensions)throw console.error("dimensions:",this.dimensions,"primitive:",this.primitive,"mesh:",this.mesh),new Error("Shapes with non-mesh primitive                must provide dimensions");let e=0,t=0,i=0,o=0;if(this.primitive===a.Circle){const e=this.dimensions.x,t=e/2;this.bBox.x=-t,this.bBox.y=-t,this.bBox.w=e,this.bBox.h=e}else if(this.primitive===a.Rect)this.bBox.x=-this.dimensions.x/2,this.bBox.y=-this.dimensions.y/2,this.bBox.w=this.dimensions.x,this.bBox.h=this.dimensions.y;else if(this.primitive===a.Mesh&&this.mesh){e=this.mesh.verticies[0].x,t=this.mesh.verticies[0].y,i=this.mesh.verticies[0].x,o=this.mesh.verticies[0].y;for(let s=1;s<this.mesh.verticies.length;++s){const{x:a,y:r}=this.mesh.verticies[s];a<e&&(e=a),a>i&&(i=a),r<t&&(t=r),r>o&&(o=r)}this.bBox.w=i-e,this.bBox.h=o-t,this.bBox.x=-this.bBox.w/2,this.bBox.y=-this.bBox.h/2}if(this.pivot===r.TopLeft?(this.bBox.x+=this.bBox.w/2,this.bBox.y+=this.bBox.h/2):this.pivot===r.TopMiddle?this.bBox.y+=this.bBox.h/2:this.pivot===r.TopRight?(this.bBox.x-=this.bBox.w/2,this.bBox.y+=this.bBox.h/2):this.pivot===r.Left?this.bBox.x+=this.bBox.w/2:this.pivot===r.Right?this.bBox.x-=this.bBox.w/2:this.pivot===r.BottomLeft?(this.bBox.x+=this.bBox.w/2,this.bBox.y-=this.bBox.h/2):this.pivot===r.BottomMiddle?this.bBox.y-=this.bBox.h/2:this.pivot===r.BottomRight&&(this.bBox.x-=this.bBox.w/2,this.bBox.y-=this.bBox.h/2),this.primitive===a.Mesh&&this.mesh)for(let i=0;i<this.mesh.verticies.length;++i)this.mesh.verticies[i].x+=this.bBox.x-e,this.mesh.verticies[i].y+=this.bBox.y-t;this.isBuilt=!0}getBBox(){return this.bBox}}},2218:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UIItem=void 0;t.UIItem=class{constructor(e,t,i,o,s,a){this.caption=e,this.color=t,this.fontSize=i,this.action=o,this.active=s,this.activeColor=a,this.captionMod=e=>e}get finalCaption(){return this.captionMod(this.caption)}}},7187:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Velocity=void 0;const o=i(7531);class s extends o.Vector2D{constructor(e,t,i){super(e,t),this.angular=i}}t.Velocity=s},3607:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.prepareRenderContext=void 0,i(7728);const o=i(3188);i(5425);const s=i(7728);t.prepareRenderContext=()=>{const e=document.querySelector("canvas");if(!e)throw new Error("Could not find canvas element!");const t=e.getContext("2d");if(!t)throw new Error("Could not initialize 2D context");const i=e.getBoundingClientRect();return e.width=i.width,e.height=i.height,t.imageSmoothingEnabled=!1,t},window.addEventListener("resize",t.prepareRenderContext);const a={topdown:o.Topdown};(async()=>{const e=await s.loadPhysics(),t=Object.keys(a).map(((e,t)=>`${t+1}) ${e}`));t.push("exit (or empty)");let i="topdown";for(;"exit"!==i;){let o=new a[i](e);await o.run(),i=prompt("What level would you like to check next?\n"+t.join("\n"))||"exit"}})().catch(console.error)},4436:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Level=void 0;const o=i(3607),s=i(5848),a=i(5081);t.Level=class{constructor(e,t){this.physics=e,this.name=t,console.log("Level loaded",t);const i=this.createWorld();if(!i)throw new Error("A level must have a non-null             resuling createWorld function");this.world=i;const s=o.prepareRenderContext();this.world.addResource(s)}destroy(){this.world.commands.stopRun()}async run(){return this.world.run({beforeStepHandler:s.beforeFrameHandler,initialState:a.MenuState}).then((()=>this.destroy()))}}},3188:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Topdown=void 0;const o=i(5038),s=i(8961),a=i(7947),r=i(7981),n=i(2019),c=i(1979),h=i(7676),l=i(2591),m=i(2958),u=i(2218),d=i(7187),p=i(242),y=i(370),v=i(3364),S=i(1638),f=i(7684),x=i(1172),g=i(1353),P=i(8842),b=i(2688),w=i(7551),M=i(1701),E=i(4436);class R extends E.Level{constructor(e){super(e,"topdown");const{b2Vec2:t,b2World:i}=e,o=new i(new t(0,9.81));this.world.addResource(o);const s=new t(0,0),a=new y.GameStore;a.physicsNamespace=e,a.physicsZero=s;const r=new p.Camera;this.world.addResource(a),this.world.addResource(r)}destroy(){super.destroy();const{physicsNamespace:e,physicsZero:t}=this.world.getResource(y.GameStore),i=this.world.getResource(e.b2World);e.destroy(i),e.destroy(t);const o=this.world.getResource(CanvasRenderingContext2D);o.fillStyle="#ececec",o.clearRect(0,0,o.canvas.width,o.canvas.height)}createWorld(){return(new o.ECS).buildWorld().withSystem(v.CameraSystem,[S.CharacterSystem]).withSystem(b.PhysicsSystem,[S.CharacterSystem]).withSystem(S.CharacterSystem,[f.CollisionSystem]).withSystem(f.CollisionSystem,[]).withSystem(x.InputSystem).withSystem(g.MenuSystem,[x.InputSystem]).withSystem(P.PauseSystem,[x.InputSystem]).withSystem(w.RenderGameSystem,[b.PhysicsSystem,S.CharacterSystem]).withSystem(M.RenderUISystem,[b.PhysicsSystem,g.MenuSystem,P.PauseSystem]).withComponents(a.Collision,r.Material,n.Mesh,h.Position,l.Rotation,m.Shape,u.UIItem,d.Velocity,s.Character,c.PhysicsBridge).build()}}t.Topdown=R},242:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Camera=t.CameraFollowMethod=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.Smooth=1]="Smooth",e[e.Elastic=2]="Elastic"}(t.CameraFollowMethod||(t.CameraFollowMethod={}));t.Camera=class{constructor(e=0,t=0,i={x:0,y:0},o={x:0,y:0},s=1,a=0,r,n=.01,c=.15){this.x=e,this.y=t,this.offset=i,this.vel=o,this.zoom=s,this.rotation=a,this.follow=r,this.elasticity=n,this.friction=c}}},370:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.GameStore=t.EMovement=void 0,function(e){e[e.idle=0]="idle",e[e.up=1]="up",e[e.down=2]="down",e[e.left=4]="left",e[e.right=8]="right"}(i=t.EMovement||(t.EMovement={}));t.GameStore=class{constructor(){this.drawables=0,this.rendered=0,this.debugShapes=!0,this.wasBlurred=!1,this.wasIntentionallyPaused=!1,this.continue=!1,this.lastFrameDeltaTime=0,this.ticks=0,this.medianFps=30,this.timeSinceLevelLoaded=0,this.input={actions:{characterMovement:i.idle,menuConfirm:!1,menuMovement:i.idle,togglePause:!1},wheel:0,cursorPos:{x:-1,y:-1},cursorPosWorld:{x:-1,y:-1},keyStates:new Map,mouseStates:new Map}}}},2189:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Rect=void 0;t.Rect=class{constructor(e,t,i,o){this.x=e,this.y=t,this.w=i,this.h=o}static checkPointInside(e,{x:t,y:i}){return!(t<e.x||t>e.x+e.w||i<e.y||i>e.y+e.h)}static checkIntersects(e,t){return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)}}},3214:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ETags=void 0,function(e){e[e.ui=0]="ui",e[e.terrain=1]="terrain",e[e.character=2]="character",e[e.networkObject=3]="networkObject",e[e.save=4]="save"}(t.ETags||(t.ETags={}))},7531:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.vecRight=t.vecLeft=t.vecDown=t.vecUp=t.vecOne=t.vecZero=t.Vector2D=void 0;class i{constructor(e=0,t=0){this.x=e,this.y=t,this.buf=new ArrayBuffer(4),this.f32=new Float32Array(this.buf),this.u32=new Uint32Array(this.buf)}addSelf(e){this.x+=e.x,this.y+=e.y}subSelf(e){this.x-=e.x,this.y-=e.y}scale(e){this.x*=e,this.y*=e}normalize(){const e=this.invSqrt();this.x*=e,this.y*=e}invSqrt(){const e=this.x*this.x+this.y*this.y,t=.5*(this.f32[0]=e);this.u32[0]=1597463007-(this.u32[0]>>1);let i=this.f32[0];return i*=1.5-t*i*i,i}distance(e){const t=e.x-this.x,i=e.y-this.y;return Math.sqrt(t*t+i*i)}sqrDistance(e){const t=e.x-this.x,i=e.y-this.y;return t*t+i*i}sqrLength(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}}t.Vector2D=i,t.vecZero=new i(0,0),t.vecOne=new i(1,1),t.vecUp=new i(0,1),t.vecDown=new i(0,-1),t.vecLeft=new i(-1,0),t.vecRight=new i(1,0)},2690:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.gamePrefab=void 0;const o=i(2958);t.gamePrefab=[{Collision:{},Position:{x:0,y:0},Rotation:{value:0},Velocity:{x:1.5,y:0},Material:{color:"#fdff03"},Shape:{dimensions:{x:2,y:.7},pivot:o.ShapePivot.TopLeft,primitive:o.ShapePrimitive.Rect}},{Collision:{},Position:{x:1,y:3},Rotation:{value:0},Velocity:{x:2,y:0},Material:{color:"#fdff03"},Shape:{zIndex:10,pivot:o.ShapePivot.TopLeft,dimensions:{x:.7},primitive:o.ShapePrimitive.Circle}},{Collision:{},Position:{x:18,y:0},Rotation:{value:7*Math.PI/4},Velocity:{x:0,y:0},Material:{color:"#0bb"},Shape:{pivot:o.ShapePivot.Middle,mesh:{verticies:[{x:-3,y:-1.25},{x:.31,y:-.31},{x:0,y:.31},{x:-1.6,y:3}]},primitive:o.ShapePrimitive.Mesh}}]},7365:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.menuPrefab=void 0;const o=i(5038),s=i(7708),a=i(3214);t.menuPrefab=[{[o.CTagMarker]:[a.ETags.ui],Position:{x:51.2,y:51.2},UIItem:{caption:"PONG",color:"#ddd",fontSize:64}},{[o.CTagMarker]:[a.ETags.ui],Position:{x:51.2,y:122.88},UIItem:{caption:"A sim-ecs usage demo",color:"#ddd",fontSize:24}},{[o.CTagMarker]:[a.ETags.ui],Position:{x:51.2,y:204.8},UIItem:{caption:"How to play: Left paddle: W/S ; Right paddle: Up/Down ; Pause: Escape",color:"#ddd",fontSize:24}},{[o.CTagMarker]:[a.ETags.ui],Position:{x:51.2,y:245.76},UIItem:{caption:"The game will be saved upon pausing!",color:"#ddd",fontSize:24}},{[o.CTagMarker]:[a.ETags.ui],Position:{x:153.6,y:358.4},UIItem:{action:s.EActions.Play,active:!0,color:"#ddd",caption:"Play",fontSize:32}},{[o.CTagMarker]:[a.ETags.ui],Position:{x:153.6,y:409.6},UIItem:{action:s.EActions.Continue,color:"#ddd",caption:"Continue",fontSize:32}},{[o.CTagMarker]:[a.ETags.ui],Position:{x:153.6,y:460.8},UIItem:{action:s.EActions.Exit,color:"#ddd",caption:"Exit",fontSize:32}}]},2687:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.pausePrefab=void 0;const o=i(5038),s=i(3214);t.pausePrefab=[{[o.CTagMarker]:[s.ETags.ui],Position:{x:50,y:30},UIItem:{caption:"❚❚ PAUSE",color:"#ddd",fontSize:64}}]},1289:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.savablePrefab=void 0;const o=i(3214),s=i(2958),a=i(5038);t.savablePrefab=[{[a.CTagMarker]:[o.ETags.character],Character:{name:"XuPoH"},Velocity:{x:0,y:0,angular:0},Collision:{},Rotation:{value:0},Position:{x:0,y:0},Shape:{zIndex:11,dimensions:{x:1},pivot:s.ShapePivot.Middle,primitive:s.ShapePrimitive.Circle},Material:{color:"#cca"}}]},7728:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.loadPhysics=void 0;const o=i(3940).__importDefault(i(1643));t.loadPhysics=async()=>o.default().then((e=>e))},2607:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GameState=void 0;const o=i(5038),s=i(1172),a=i(8842),r=i(2690),n=i(7676),c=i(370),h=i(1758),l=i(1701),m=i(7551),u=i(2958),d=i(2688),p=i(7684),y=i(1638),v=i(1289),S=i(1979),f=i(3364);class x extends o.State{constructor(){super(...arguments),this._systems=[d.PhysicsSystem,y.CharacterSystem,p.CollisionSystem,s.InputSystem,f.CameraSystem,a.PauseSystem,m.RenderGameSystem,l.RenderUISystem]}activate(e){e.getResource(c.GameStore).currentState=this}async create(e){var t;const i=e.getResource(c.GameStore);this.staticDataPrefabHandle=g(e),i.continue?this.saveDataPrefabHandle=h.load(e):this.saveDataPrefabHandle=P(e),await e.flushCommands();for(const i of e.getEntities(new o.Query([o.With(u.Shape)])))null===(t=i.getComponent(u.Shape))||void 0===t||t.build();const{b2World:s,b2CircleShape:a,b2Shape:r,b2PolygonShape:l,b2BodyDef:m,b2_dynamicBody:d,b2Vec2:p,destroy:y}=i.physicsNamespace,v=e.getResource(s),f=i.physicsZero;let x=null;for(const t of e.getEntities(new o.Query([o.With(u.Shape),o.With(n.Position),o.With(S.PhysicsBridge)]))){const e=t.getComponent(n.Position),i=t.getComponent(u.Shape),o=t.getComponent(S.PhysicsBridge);console.log("Adding to physics world:",e,i);const s=new p(e.x,e.y),r=new m,{w:c,h}=i.getBBox();if(i.primitive===u.ShapePrimitive.Rect){const e=new l;e.SetAsBox(c,h),x=e}else if(i.primitive===u.ShapePrimitive.Circle){const e=new a;e.set_m_radius(i.dimensions.x/2),x=e}else console.error(i.primitive,"is not supported by physics now");if(x){r.set_type(d),r.set_position(s);const e=v.CreateBody(r);s.Set(0,0),e.SetTransform(s,0),e.CreateFixture(x,1),y(s),y(x),e.SetLinearVelocity(f),e.SetAwake(!0),e.SetEnabled(!0),o.bodyPtr=e}}e.commands.maintain()}destroy(e){this.staticDataPrefabHandle&&e.commands.unloadPrefab(this.staticDataPrefabHandle),this.saveDataPrefabHandle&&e.commands.unloadPrefab(this.saveDataPrefabHandle);const{physicsNamespace:{b2World:t,destroy:i}}=e.getResource(c.GameStore);i(e.getResource(t)),e.commands.maintain()}}t.GameState=x;const g=function(e){return e.commands.load(o.SerialFormat.fromArray(r.gamePrefab))},P=function(e){return e.commands.load(o.SerialFormat.fromArray(v.savablePrefab))}},5081:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MenuState=void 0;const o=i(5038),s=i(7365),a=i(1172),r=i(1353),n=i(1701),c=i(370);class h extends o.State{constructor(){super(...arguments),this._systems=[a.InputSystem,r.MenuSystem,n.RenderUISystem]}activate(e){e.getResource(c.GameStore).currentState=this,this.prefabHandle=e.commands.load(o.SerialFormat.fromArray(s.menuPrefab)),e.commands.maintain()}deactivate(e){e.commands.unloadPrefab(this.prefabHandle),e.commands.maintain()}}t.MenuState=h},8415:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PauseState=void 0;const o=i(5038),s=i(1172),a=i(8842),r=i(2687),n=i(370),c=i(1758),h=i(1701),l=i(7551);class m extends o.State{constructor(){super(...arguments),this._systems=[s.InputSystem,a.PauseSystem,l.RenderGameSystem,h.RenderUISystem]}activate(e){const t=e.getResource(n.GameStore);c.save(e),t.currentState=this,this.prefabHandle=e.commands.load(o.SerialFormat.fromArray(r.pausePrefab)),e.commands.maintain()}deactivate(e){e.commands.unloadPrefab(this.prefabHandle),e.commands.maintain()}}t.PauseState=m},3364:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CameraSystem=void 0;const o=i(5038),s=i(242),a=i(7276);class r extends o.System{setup(e){this.ctx=e.getResource(CanvasRenderingContext2D),this.camera=e.getResource(s.Camera)}run(e){this.camera.rotation>2*Math.PI&&(this.camera.rotation-=2*Math.PI),this.camera.rotation<-2*Math.PI&&(this.camera.rotation+=2*Math.PI),this.camera.zoom<.1&&(this.camera.zoom=.1),this.camera.zoom>1.5&&(this.camera.zoom=1.5);const{follow:t,offset:i}=this.camera;if(!t)return;const{target:o,method:r}=t;let n=o.x,c=o.y;if(i.x=-this.ctx.canvas.width/(2*this.camera.zoom*a.PIXELS_PER_METER),i.y=-this.ctx.canvas.height/(2*this.camera.zoom*a.PIXELS_PER_METER),r===s.CameraFollowMethod.Immediate)this.camera.x=n,this.camera.y=c;else if(r===s.CameraFollowMethod.Smooth)this.camera.x=a.lerp(this.camera.x,n,.01),this.camera.y=a.lerp(this.camera.y,c,.01);else if(r===s.CameraFollowMethod.Elastic){const e=(n-this.camera.x)*this.camera.elasticity,t=(c-this.camera.y)*this.camera.elasticity;this.camera.vel.x+=e,this.camera.vel.y+=t;const i=-this.camera.friction*this.camera.vel.x,o=-this.camera.friction*this.camera.vel.y;this.camera.vel.x+=i,this.camera.vel.y+=o,this.camera.x+=this.camera.vel.x/this.camera.zoom,this.camera.y+=this.camera.vel.y/this.camera.zoom}}}t.CameraSystem=r},1638:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CharacterSystem=void 0;const o=i(5038),s=i(3214),a=i(7187),r=i(370),n=i(7676),c=i(242),h=i(7276);class l extends o.System{constructor(){super(...arguments),this.query=new o.Query({_character:o.WithTag(s.ETags.character),pos:o.Read(n.Position),velocity:o.Write(a.Velocity)}),this.runs=0}setup(e){this.ctx=e.getResource(CanvasRenderingContext2D),this.gameStore=e.getResource(r.GameStore),this.camera=e.getResource(c.Camera),this.camera.elasticity=.008,this.camera.follow={method:c.CameraFollowMethod.Elastic,target:{x:this.camera.x,y:this.camera.y},prevX:this.camera.x,prevY:this.camera.y}}run(e){this.camera.zoom+=this.gameStore.input.wheel/10,this.query.execute((({pos:e,velocity:t})=>{this.camera.follow.target=e;const i=this.gameStore.lastFrameDeltaTime,{characterMovement:o}=this.gameStore.input.actions,s=(o&r.EMovement.left)===r.EMovement.left,a=(o&r.EMovement.right)===r.EMovement.right;t.x=0,s&&!a&&(t.x=-1),a&&!s&&(t.x=1),(o&r.EMovement.up)===r.EMovement.up?t.y=-1:(o&r.EMovement.down)===r.EMovement.down?t.y=1:t.y=0,t.normalize(),t.scale(1e3*i*10/h.PIXELS_PER_METER)}))}}t.CharacterSystem=l},7684:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CollisionSystem=void 0;const o=i(5038),s=i(2958),a=i(7947),r=i(7531);class n extends o.System{constructor(){super(...arguments),this.query=new o.Query({collision:o.Write(a.Collision),entity:o.ReadEntity(),position:o.Read(r.Vector2D),shape:o.Read(s.Shape)})}run(e){const t=Array.from(this.query.iter()).map((({collision:e,entity:t,position:i,shape:o})=>{e.collisionObjects.clear(),e.occurred=!1;const{x:s,y:a,w:r,h:n}=o.getBBox();return{collisionData:e,entity:t,width:r,height:n,x:i.x+s,y:i.y+a}}));for(let e=0;e<t.length;e++)for(let i=0;i<t.length;i++){if(e==i)continue;const o=t[e],s=t[i];o.x<s.x+s.width&&o.x+o.width>s.x&&o.y<s.y+s.height&&o.y+o.height>s.y&&(o.collisionData.occurred||(o.collisionData.occurred=!0,o.collisionData.collisionObjects.add(s.entity)),s.collisionData.occurred||(s.collisionData.occurred=!0,s.collisionData.collisionObjects.add(o.entity)))}}}t.CollisionSystem=n},1172:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.InputSystem=t.EMouseState=t.EKeyState=void 0;const o=i(3940).__importStar(i(186)),s=i(5038),a=i(370);var r,n;!function(e){e[e.Down=0]="Down",e[e.Up=1]="Up"}(r=t.EKeyState||(t.EKeyState={})),function(e){e[e.Down=0]="Down",e[e.Up=1]="Up",e[e.Move=2]="Move"}(n=t.EMouseState||(t.EMouseState={}));class c extends s.System{constructor(){super(...arguments),this.inputEvents=[],this.mouseEvents=[],this.wheelEvents=[],this.listeners={wheel:e=>this.wheelEvents.push(-e.deltaY/125),keydown:e=>this.inputEvents.push({code:e.code,type:r.Down}),keyup:e=>this.inputEvents.push({code:e.code,type:r.Up}),mousedown:e=>this.mouseEvents.push({button:e.button,type:n.Down,x:e.clientX,y:e.clientY}),mouseup:e=>this.mouseEvents.push({button:e.button,type:n.Up,x:e.clientX,y:e.clientY}),mousemove:e=>this.mouseEvents.push({button:e.button,type:n.Move,x:e.clientX,y:e.clientY}),blur:()=>{this.gameStore.input.actions.characterMovement=a.EMovement.idle,this.gameStore.input.actions.menuMovement=a.EMovement.idle,this.gameStore.input.actions.togglePause=!1},focus:()=>this.listeners.blur(),contextmenu:e=>e.preventDefault()}}setup(e){this.gameStore=e.getResource(a.GameStore);for(const[e,t]of Object.entries(this.listeners))window.addEventListener(e,t)}destroy(e){super.destroy(e);for(const[e,t]of Object.entries(this.listeners))window.removeEventListener(e,t)}run(e){let t,i,s;for(this.gameStore.input.actions.menuConfirm=!1,this.gameStore.input.actions.menuMovement=a.EMovement.idle,this.gameStore.input.actions.togglePause=!1,this.gameStore.input.keyStates.clear();t=this.inputEvents.pop();)switch(this.gameStore.input.keyStates.set(t.code,t.type),t.code){case o.CODE_ENTER:t.type===r.Down&&(this.gameStore.input.actions.menuConfirm=!0);break;case o.CODE_ESCAPE:t.type===r.Down&&(this.gameStore.input.actions.togglePause=!0);break;case o.CODE_W:case o.CODE_UP:t.type===r.Down?(this.gameStore.input.actions.characterMovement|=a.EMovement.up,this.gameStore.input.actions.characterMovement&=~a.EMovement.down,this.gameStore.input.actions.menuMovement=a.EMovement.up):this.gameStore.input.actions.characterMovement&=~a.EMovement.up;break;case o.CODE_A:case o.CODE_LEFT:t.type===r.Down?(this.gameStore.input.actions.characterMovement|=a.EMovement.left,this.gameStore.input.actions.characterMovement&=~a.EMovement.right):this.gameStore.input.actions.characterMovement&=~a.EMovement.left;break;case o.CODE_S:case o.CODE_DOWN:t.type===r.Down?(this.gameStore.input.actions.characterMovement|=a.EMovement.down,this.gameStore.input.actions.characterMovement&=~a.EMovement.up,this.gameStore.input.actions.menuMovement=a.EMovement.down):this.gameStore.input.actions.characterMovement&=~a.EMovement.down,this.gameStore.input.actions.menuMovement=this.gameStore.input.actions.characterMovement;break;case o.CODE_D:case o.CODE_RIGHT:t.type===r.Down?(this.gameStore.input.actions.characterMovement|=a.EMovement.right,this.gameStore.input.actions.characterMovement&=~a.EMovement.left):this.gameStore.input.actions.characterMovement&=~a.EMovement.right}for(this.gameStore.input.mouseStates.clear();i=this.mouseEvents.pop();){const{type:e,x:t,y:o,button:s}=i;this.gameStore.input.mouseStates.set(s,e),this.gameStore.input.cursorPos.x=t,this.gameStore.input.cursorPos.y=o}for(this.gameStore.input.wheel=0;s=this.wheelEvents.pop();)this.gameStore.input.wheel=s}}t.InputSystem=c},1353:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MenuSystem=void 0;const o=i(5038),s=i(2218),a=i(370),r=i(7708),n=i(2607),c=i(5081);class h extends o.System{constructor(){super(...arguments),this._states=[n.GameState,c.MenuState],this.query=new o.Query({uiItem:o.Write(s.UIItem)}),this.menuAction=r.EActions.Play}setup(e){this.actions=e,this.gameStore=e.getResource(a.GameStore),console.log("setup Menu")}run(e){if(this.gameStore.input.actions.menuMovement==a.EMovement.down)switch(this.menuAction){case r.EActions.Play:this.menuAction=r.EActions.Continue;break;case r.EActions.Continue:this.menuAction=r.EActions.Exit;break;case r.EActions.Exit:this.menuAction=r.EActions.Play;break;default:throw new Error(`Action ${this.menuAction} not implemented!`)}else if(this.gameStore.input.actions.menuMovement==a.EMovement.up)switch(this.menuAction){case r.EActions.Play:this.menuAction=r.EActions.Exit;break;case r.EActions.Continue:this.menuAction=r.EActions.Play;break;case r.EActions.Exit:this.menuAction=r.EActions.Continue;break;default:throw new Error(`Action ${this.menuAction} not implemented!`)}if(this.gameStore.input.actions.menuConfirm)if(this.menuAction==r.EActions.Play)this.actions.commands.pushState(n.GameState);else if(this.menuAction==r.EActions.Continue){if(null==localStorage.getItem("save"))return void alert("Sorry you werent saved lol");this.gameStore.continue=!0,this.actions.commands.pushState(n.GameState)}else this.actions.commands.stopRun();else for(const{uiItem:e}of this.query.iter())e.active=e.action==this.menuAction}}t.MenuSystem=h},8842:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PauseSystem=void 0;const o=i(5038),s=i(370),a=i(2607),r=i(8415);class n extends o.System{setup(e){this.actions=e,this.gameStore=e.getResource(s.GameStore),window.addEventListener("blur",(()=>{var e,t;const i=(null===(e=this.gameStore.currentState)||void 0===e?void 0:e.constructor)==a.GameState,o=(null===(t=this.gameStore.currentState)||void 0===t?void 0:t.constructor)==r.PauseState;(i||o)&&(o||(this.actions.commands.pushState(r.PauseState),this.gameStore.wasBlurred=!0))})),window.addEventListener("focus",(()=>{this.gameStore.wasBlurred&&!this.gameStore.wasIntentionallyPaused&&this.actions.commands.popState()}))}run(e){var t,i;const o=(null===(t=this.gameStore.currentState)||void 0===t?void 0:t.constructor)==a.GameState,s=(null===(i=this.gameStore.currentState)||void 0===i?void 0:i.constructor)==r.PauseState;(o||s)&&this.gameStore.input.actions.togglePause&&(o?(this.gameStore.wasIntentionallyPaused=!0,this.actions.commands.pushState(r.PauseState)):(this.gameStore.wasIntentionallyPaused=!1,this.actions.commands.popState()))}}t.PauseSystem=n},2688:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PhysicsSystem=void 0;const o=i(5038),s=i(7676),a=i(2591),r=i(7187),n=i(370),c=i(1979);class h extends o.System{constructor(){super(...arguments),this.query=new o.Query({entity:o.ReadEntity(),pos:o.Write(s.Position),rot:o.Write(a.Rotation),vel:o.Read(r.Velocity)})}setup(e){const{physicsNamespace:{b2World:t}}=e.getResource(n.GameStore);this.physWorld=e.getResource(t)}run(e){const t=.016,{physicsNamespace:{getPointer:i,NULL:o}}=e.getResource(n.GameStore);this.query.execute((({entity:e,pos:i,rot:o,vel:s})=>{const a=e.getComponent(c.PhysicsBridge);if(a){const e=a.bodyPtr;if(!e)return;const{x:t,y:o}=e.GetPosition();console.log(t,o),i.x=t,i.y=o}else i.x+=s.x*t,i.y+=s.y*t,o.value+=s.angular*t})),this.physWorld.Step(t,1,1)}}t.PhysicsSystem=h},7551:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RenderGameSystem=void 0;const o=i(5038),s=i(2958),a=i(7676),r=i(7981),n=i(370),c=i(2189),h=i(242),l=i(2591),m=i(7276);class u extends o.System{constructor(){super(...arguments),this.query=new o.Query({pos:o.Read(a.Position),rot:o.Write(l.Rotation),shape:o.Read(s.Shape),material:o.Read(r.Material)}),this.runs=0}setup(e){this.ctx=e.getResource(CanvasRenderingContext2D),this.gameStore=e.getResource(n.GameStore),this.camera=e.getResource(h.Camera),this.controls=document.querySelector("#controls")}run(e){const t={x:this.camera.x+this.camera.offset.x,y:this.camera.y+this.camera.offset.y,w:this.ctx.canvas.width/(this.camera.zoom*m.PIXELS_PER_METER),h:this.ctx.canvas.height/(this.camera.zoom*m.PIXELS_PER_METER)};this.camera.viewport=t,this.ctx.save(),this.ctx.scale(m.PIXELS_PER_METER*this.camera.zoom,m.PIXELS_PER_METER*this.camera.zoom),this.ctx.translate(-t.x,-t.y),this.ctx.translate(this.camera.x,this.camera.y),this.ctx.rotate(this.camera.rotation),this.ctx.translate(-this.camera.x,-this.camera.y),this.gameStore.worldToScreen=this.ctx.getTransform(),this.gameStore.screenToWorld=this.ctx.getTransform().inverse();const{x:i,y:o}=this.gameStore.input.cursorPos,{a:s,b:a,c:r,d:n,e:h,f:l}=this.gameStore.screenToWorld;this.gameStore.input.cursorPosWorld.x=s*i+r*o+h,this.gameStore.input.cursorPosWorld.y=a*i+n*o+l;const u=this.ctx.canvas.width/(18*m.PIXELS_PER_METER),d=this.ctx.canvas.height/(10*m.PIXELS_PER_METER);for(let e=0;e<10;e++)for(let t=0;t<18;t++){const i=t*u,o=e*d;this.ctx.lineWidth=2/32,this.ctx.strokeStyle="#dadada",this.ctx.strokeRect(i,o,u,d)}const p=Array.from(this.query.iter());this.gameStore.drawables=p.length;const y=p.filter((({pos:e,shape:i})=>{const o=i.getBBox(),s={x:e.x+o.x,y:e.y+o.y,w:o.w,h:o.h};return c.Rect.checkIntersects(s,t)})).sort((({shape:e},{shape:t})=>e.zIndex-t.zIndex));this.gameStore.rendered=y.length;for(let e=0;e<y.length;e++){const{pos:t,shape:i,rot:o,material:s}=y[e];this.drawShape(t,i,s,o)}this.ctx.restore()}drawShape(e,t,i,o){const{x:a,y:r}=t.dimensions,{x:n,y:c,w:h,h:l}=t.getBBox(),{x:u,y:d}=e;if(this.ctx.save(),this.ctx.translate(u,d),this.ctx.rotate(o.value),this.ctx.fillStyle=i.color,t.primitive===s.ShapePrimitive.Rect)this.ctx.fillRect(n,c,a,r);else if(t.primitive===s.ShapePrimitive.Circle)this.ctx.beginPath(),this.ctx.arc(n+a/2,n+a/2,a/2,0,m.TWOPI),this.ctx.fill();else if(t.primitive===s.ShapePrimitive.Mesh&&t.mesh){this.ctx.beginPath();const{offsetX:e,offsetY:i}=t;for(let o=0;o<t.mesh.verticies.length;++o){const{x:s,y:a}=t.mesh.verticies[o];this.ctx.lineTo(s+e,a+i)}this.ctx.closePath(),this.ctx.fill()}if(this.gameStore.debugShapes){this.ctx.save(),this.ctx.fillStyle="#fff",this.ctx.font="0.1rem Arial",this.ctx.fillText(`Z=${t.zIndex},x=${Math.floor(u)},y=${Math.floor(d)}`,0,-c-2),this.ctx.fillText(`Pivot=${s.ShapePivotNames[t.pivot]}`,0,-c-3),this.ctx.strokeStyle="#f0f";const e=0;this.ctx.lineWidth=.1,this.ctx.strokeRect(n-e,c-e,h+2*e,l+2*e),this.ctx.restore(),m.drawPoint(this.ctx,0,0)}this.ctx.restore()}}t.RenderGameSystem=u},1701:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RenderUISystem=void 0;const o=i(5038),s=i(2218),a=i(7676),r=i(370),n=i(3214);class c extends o.System{constructor(){super(...arguments),this.query=new o.Query({_tag:o.WithTag(n.ETags.ui),pos:o.Read(a.Position),ui:o.Read(s.UIItem)}),this.runs=0}setup(e){this.ctx=e.getResource(CanvasRenderingContext2D),this.gameStore=e.getResource(r.GameStore)}run(e){this.ctx.textBaseline="top",this.ctx.save(),this.query.execute((({pos:e,ui:t})=>{var i;this.ctx.fillStyle=t.active?null!==(i=t.activeColor)&&void 0!==i?i:"red":t.color,this.ctx.font=t.active?1.2*t.fontSize+"px serif":`${t.fontSize}px serif`,this.ctx.fillText(t.finalCaption,e.x,e.y)})),this.ctx.restore(),this.ctx.font="32px serif",this.ctx.fillStyle="#fff",this.ctx.fillText(Math.floor(10*this.gameStore.timeSinceLevelLoaded)/10+" s.",this.ctx.canvas.width-200,20),this.ctx.fillText(`${Math.floor(this.gameStore.medianFps+.5)} FPS`,this.ctx.canvas.width-200,60),this.ctx.fillText(`${this.gameStore.rendered} / ${this.gameStore.drawables}`,this.ctx.canvas.width-200,100);{let e=this.gameStore.input.actions.characterMovement.toString(2);e="0".repeat(4-e.length)+e,this.ctx.fillText(`${e}`,this.ctx.canvas.width-200,140)}}}t.RenderUISystem=c}},s={};function a(e){var t=s[e];if(void 0!==t)return t.exports;var i=s[e]={exports:{}};return o[e](i,i.exports,a),i.exports}a.m=o,e=[],a.O=(t,i,o,s)=>{if(!i){var r=1/0;for(l=0;l<e.length;l++){for(var[i,o,s]=e[l],n=!0,c=0;c<i.length;c++)(!1&s||r>=s)&&Object.keys(a.O).every((e=>a.O[e](i[c])))?i.splice(c--,1):(n=!1,s<r&&(r=s));if(n){e.splice(l--,1);var h=o();void 0!==h&&(t=h)}}return t}s=s||0;for(var l=e.length;l>0&&e[l-1][2]>s;l--)e[l]=e[l-1];e[l]=[i,o,s]},a.d=(e,t)=>{for(var i in t)a.o(t,i)&&!a.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,i)=>(a.f[i](e,t),t)),[])),a.u=e=>e+".js",a.miniCssF=e=>{},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},i="citylights:",a.l=(e,o,s,r)=>{if(t[e])t[e].push(o);else{var n,c;if(void 0!==s)for(var h=document.getElementsByTagName("script"),l=0;l<h.length;l++){var m=h[l];if(m.getAttribute("src")==e||m.getAttribute("data-webpack")==i+s){n=m;break}}n||(c=!0,(n=document.createElement("script")).charset="utf-8",n.timeout=120,a.nc&&n.setAttribute("nonce",a.nc),n.setAttribute("data-webpack",i+s),n.src=e),t[e]=[o];var u=(i,o)=>{n.onerror=n.onload=null,clearTimeout(d);var s=t[e];if(delete t[e],n.parentNode&&n.parentNode.removeChild(n),s&&s.forEach((e=>e(o))),i)return i(o)},d=setTimeout(u.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=u.bind(null,n.onerror),n.onload=u.bind(null,n.onload),c&&document.head.appendChild(n)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");i.length&&(e=i[i.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{a.b=document.baseURI||self.location.href;var e={179:0};a.f.j=(t,i)=>{var o=a.o(e,t)?e[t]:void 0;if(0!==o)if(o)i.push(o[2]);else{var s=new Promise(((i,s)=>o=e[t]=[i,s]));i.push(o[2]=s);var r=a.p+a.u(t),n=new Error;a.l(r,(i=>{if(a.o(e,t)&&(0!==(o=e[t])&&(e[t]=void 0),o)){var s=i&&("load"===i.type?"missing":i.type),r=i&&i.target&&i.target.src;n.message="Loading chunk "+t+" failed.\n("+s+": "+r+")",n.name="ChunkLoadError",n.type=s,n.request=r,o[1](n)}}),"chunk-"+t,t)}},a.O.j=t=>0===e[t];var t=(t,i)=>{var o,s,[r,n,c]=i,h=0;for(o in n)a.o(n,o)&&(a.m[o]=n[o]);if(c)var l=c(a);for(t&&t(i);h<r.length;h++)s=r[h],a.o(e,s)&&e[s]&&e[s][0](),e[r[h]]=0;return a.O(l)},i=self.webpackChunkcitylights=self.webpackChunkcitylights||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var r=a.O(void 0,[319],(()=>a(3607)));r=a.O(r)})();
//# sourceMappingURL=main.js.map