/*! For license information please see 895.js.LICENSE.txt */
"use strict";(self.webpackChunkcitylights=self.webpackChunkcitylights||[]).push([[895],{3488:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CommandEntityBuilder=void 0;const s=r(4107),n=r(646);s.__exportStar(r(8090),t),t.CommandEntityBuilder=class{constructor(e){this.commands=e,this.entity=new n.Entity}build(){this.commands.aggregator.addCommand((()=>this.commands.world.addEntity(this.entity)))}with(e,...t){return this.entity.addComponent(this.asComponent(e)),this}withAll(...e){let t;for(t of e)this.with(t);return this}asComponent(e,...t){return"object"==typeof e?e:new(e.prototype.constructor.bind(e,...Array.from(arguments).slice(1)))}}},8090:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},3599:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CommandsAggregator=void 0,r(4107).__exportStar(r(1459),t),t.CommandsAggregator=class{constructor(e){this.world=e,this.commands=[],this.doMaintain=!1}addCommand(e){this.commands.push(e)}async executeAll(){for(let e=this.commands.shift();e;e=this.commands.shift())await e();this.doMaintain&&this.world.maintain()}triggerMaintain(){this.doMaintain=!0}}},1459:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9443:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Commands=void 0;const s=r(4107),n=r(3488);s.__exportStar(r(686),t),t.Commands=class{constructor(e,t){this.world=e,this.aggregator=t}addEntity(e){this.aggregator.addCommand((()=>this.world.addEntity(e)))}addResource(e,...t){let r,s;if("object"==typeof e?(r=e.constructor,s=e):(r=e,s=new(e.prototype.constructor.bind(e,...Array.from(arguments).slice(1)))),this.world.resources.has(r))throw new Error(`Resource with name "${r.name}" already exists!`);return this.aggregator.addCommand((()=>{if(this.world.resources.has(r))throw new Error(`Resource with name "${r.name}" already exists!`);this.world.resources.set(r,s)})),s}buildEntity(){return new n.CommandEntityBuilder(this)}clearEntities(){this.aggregator.addCommand((()=>this.world.entities.clear()))}load(e,t){const r=this.world.groups.nextHandle++;return this.aggregator.addCommand((()=>{this.world.load(e,t,r)})),r}maintain(){this.aggregator.triggerMaintain()}merge(e){const t=this.world.groups.nextHandle++;return this.aggregator.addCommand((()=>{this.world.merge(e,t)})),t}popState(){this.aggregator.addCommand((()=>this.world.popState()))}pushState(e){this.aggregator.addCommand((()=>this.world.pushState(e)))}queueCommand(e){this.aggregator.addCommand(e)}removeEntity(e){this.aggregator.addCommand((()=>this.world.removeEntity(e)))}removeResource(e){if(!this.world.resources.has(e))throw new Error(`Resource with name "${e.name}" does not exists!`);this.aggregator.addCommand((()=>{if(!this.world.resources.has(e))throw new Error(`Resource with name "${e.name}" does not exists!`);this.world.resources.delete(e)}))}replaceResource(e,...t){let r;if(r="object"==typeof e?e.constructor:e,!this.world.resources.has(r))throw new Error(`Resource with name "${r.name}" does not exists!`);this.aggregator.addCommand((()=>{if(!this.world.resources.has(r))throw new Error(`Resource with name "${r.name}" does not exists!`);this.world.resources.delete(r),this.world.addResource(e,...t)}))}stopRun(){this.aggregator.addCommand((()=>this.world.stopRun()))}unloadPrefab(e){this.aggregator.addCommand((()=>this.world.unloadPrefab(e)))}}},686:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},1471:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ECS=void 0;const s=r(875);class n{constructor(){this.worlds=new Map}buildWorld(e){return new s.WorldBuilder(this).addCallback((t=>this.worlds.set(t,{name:e,world:t})))}removeWorld(e){this.worlds.delete(e)}}t.ECS=n,t.default=n},4429:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EntityBuilder=void 0;const s=r(4107),n=r(646);s.__exportStar(r(423),t),t.EntityBuilder=class{constructor(){this.entity=new n.Entity}build(){return this.entity}with(e,...t){return this.entity.addComponent(this.asComponent(e)),this}withAll(...e){let t;for(t of e)this.with(t);return this}asComponent(e,...t){return"object"==typeof e?e:new(e.prototype.constructor.bind(e,...Array.from(arguments).slice(1)))}}},423:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},646:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Entity=void 0,r(4107).__exportStar(r(3718),t),t.Entity=class{constructor(){this.components=new Map,this.tags=new Set}addComponent(e){if(this.hasComponent(e.constructor))throw new Error(`Component "${e.constructor.name}" already exists on entity!`);return this.components.set(e.constructor,e),this}addTag(e){return this.tags.add(e),this}getComponent(e){return this.components.get(e)}getComponents(){return this.components.values()}getTags(){return this.tags.values()}hasComponent(e){return this.components.has(e)}hasTag(e){return this.tags.has(e)}removeComponent(e){return this.components.delete(e.constructor),this}removeTag(e){return this.tags.delete(e),this}}},3718:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},895:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=r(4107);s.__exportStar(r(1471),t),s.__exportStar(r(646),t),s.__exportStar(r(4429),t),s.__exportStar(r(433),t),s.__exportStar(r(1634),t),s.__exportStar(r(9297),t),s.__exportStar(r(8966),t),s.__exportStar(r(3247),t),s.__exportStar(r(1662),t)},6680:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PushDownAutomaton=void 0,t.PushDownAutomaton=class{get state(){return this.currentState}clear(){this.currentState=void 0,this.statesTail=void 0}pop(){var e;if(!this.statesTail)return;const t=this.statesTail;return this.statesTail=this.statesTail.prevNode,this.currentState=null===(e=this.statesTail)||void 0===e?void 0:e.state,t.state}push(e){this.currentState=new e,this.statesTail={prevNode:this.statesTail,state:this.currentState}}}},433:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WithoutTag=t.Without=t.WithTag=t.With=t.Write=t.Read=t.ReadEntity=t.Query=void 0;const s=r(4107),n=r(2159),i=r(646);s.__exportStar(r(2159),t);class o{constructor(e){this.queryDescriptor=e,this.queryResult=new Map}get descriptor(){return this.queryDescriptor}[n.addEntitySym](e){this.matchesEntity(e)&&(Array.isArray(this.queryDescriptor)?this.queryResult.set(e,e):this.queryResult.set(e,this.getDataFromEntity(e,this.queryDescriptor)))}[n.clearEntitiesSym](){this.queryResult.clear()}[n.removeEntitySym](e){this.queryResult.delete(e)}[n.setEntitiesSym](e){let t;for(t of(this.queryResult.clear(),e))this[n.addEntitySym](t)}execute(e){let t;for(t of this.queryResult.values())e(t)}getDataFromEntity(e,t){const r={};let s;for(s of Object.entries(t))s[1][n.accessDescSym].type==n.EAccess.meta?s[1][n.accessDescSym].targetType==n.ETargetType.entity&&(r[s[0]]=e):r[s[0]]=e.getComponent(s[1][n.accessDescSym].target);return r}iter(e){if(e){const t=[],r=e.getEntities(this);let s;for(s of r)t.push(this.getDataFromEntity(s,this.queryDescriptor));return t.values()}return this.queryResult.values()}matchesEntity(e){if(Array.isArray(this.queryDescriptor)){let t;for(t of this.queryDescriptor){if(t[n.existenceDescSym].targetType==n.ETargetType.tag&&e.hasTag(t[n.existenceDescSym].target)!=(t[n.existenceDescSym].type==n.EExistence.set))return!1;if(t[n.existenceDescSym].targetType==n.ETargetType.component&&e.hasComponent(t[n.existenceDescSym].target)!=(t[n.existenceDescSym].type==n.EExistence.set))return!1}}else{let t;for(t of Object.values(this.queryDescriptor)){if(t[n.accessDescSym].targetType==n.ETargetType.tag&&!e.hasTag(t[n.accessDescSym].target))return!1;if(t[n.accessDescSym].targetType==n.ETargetType.component&&!e.hasComponent(t[n.accessDescSym].target))return!1}}return!0}}t.Query=o,t.ReadEntity=function(){return Object.assign({},i.Entity,{[n.accessDescSym]:{target:i.Entity,targetType:n.ETargetType.entity,type:n.EAccess.meta}})},t.Read=function(e){return Object.assign({},e.prototype,{[n.accessDescSym]:{target:e,targetType:n.ETargetType.component,type:n.EAccess.read}})},t.Write=function(e){return Object.assign({},e.prototype,{[n.accessDescSym]:{target:e,targetType:n.ETargetType.component,type:n.EAccess.write}})},t.With=function(e){return{[n.existenceDescSym]:{target:e,targetType:n.ETargetType.component,type:n.EExistence.set}}},t.WithTag=function(e){return{[n.accessDescSym]:{target:e,targetType:n.ETargetType.tag,type:n.EAccess.meta},[n.existenceDescSym]:{target:e,targetType:n.ETargetType.tag,type:n.EExistence.set}}},t.Without=function(e){return{[n.existenceDescSym]:{target:e,targetType:n.ETargetType.component,type:n.EExistence.unset}}},t.WithoutTag=function(e){return{[n.existenceDescSym]:{target:e,targetType:n.ETargetType.tag,type:n.EExistence.unset}}}},2159:(e,t)=>{var r,s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.ETargetType=t.EExistence=t.EAccess=t.existenceDescSym=t.accessDescSym=t.setEntitiesSym=t.removeEntitySym=t.clearEntitiesSym=t.addEntitySym=void 0,t.addEntitySym=Symbol(),t.clearEntitiesSym=Symbol(),t.removeEntitySym=Symbol(),t.setEntitiesSym=Symbol(),t.accessDescSym=Symbol(),t.existenceDescSym=Symbol(),(n=t.EAccess||(t.EAccess={}))[n.meta=0]="meta",n[n.read=1]="read",n[n.write=2]="write",(s=t.EExistence||(t.EExistence={}))[s.set=0]="set",s[s.unset=1]="unset",(r=t.ETargetType||(t.ETargetType={}))[r.component=0]="component",r[r.entity=1]="entity",r[r.tag=2]="tag"},2391:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultDeserializer=t.getDefaultSerializer=void 0,t.getDefaultSerializer=function(e){return t=>{let r=typeof t;switch(typeof t){case"number":return t;case"object":if(null==t)return"null";switch(r=t.constructor.name,t.constructor.name){case"Date":return t.getTime();case"Array":case"Object":return JSON.stringify(t.toString());case"Map":case"Set":return JSON.stringify(Array.from(t));case"Number":return t}break;case"string":return JSON.stringify(t)}if(!e)throw new Error(`Missing serializer for "${r}"!`);return e(t)}},t.getDefaultDeserializer=function(e){return(t,r)=>{switch(t.toLowerCase()){case"array":if(!Array.isArray(r))throw new Error(`Cannot deserialize Array with data of type ${typeof r}! Array expected!`);return r;case"date":if("number"!=typeof r)throw new Error(`Cannot deserialize Date with data of type ${typeof r}! Number expected!`);return new Date(r);case"map":if(!Array.isArray(r))throw new Error(`Cannot deserialize Map with data of type ${typeof r}! Array of arrays expected!`);return new Map(r);case"number":if("number"!=typeof r)throw new Error(`Cannot deserialize Number with data of type ${typeof r}! Number expected!`);return r;case"object":if("object"!=typeof r)throw new Error(`Cannot deserialize Object with data of type ${typeof r}! Object expected!`);return r;case"set":if(!Array.isArray(r))throw new Error(`Cannot deserialize Set with data of type ${typeof r}! Array expected!`);return new Set(r);case"string":if("string"!=typeof r)throw new Error(`Cannot deserialize String with data of type ${typeof r}! String expected!`);return r}if(!e)throw new Error(`Missing deserializer for "${t}"!`);return e(t,r)}}},1634:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SerDe=void 0;const s=r(4107),n=r(2568),i=r(9297),o=r(2391),a=r(646);s.__exportStar(r(2568),t),t.SerDe=class{constructor(){this.typeHandlers=new Map}deserialize(e,t){var r,s;const i={useDefaultHandler:null===(r=null==t?void 0:t.useDefaultHandler)||void 0===r||r,useRegisteredHandlers:null===(s=null==t?void 0:t.useRegisteredHandlers)||void 0===s||s,fallbackHandler:null==t?void 0:t.fallbackHandler},c=[];let u,l,d,h,y;for(h of e){for([d,l]of(u=new a.Entity,Object.entries(h)))if(i.useRegisteredHandlers&&this.typeHandlers.has(d))u.addComponent(this.typeHandlers.get(d).deserializer(l));else if(d==n.CTagMarker){if(!Array.isArray(l))throw new Error("Expected array of tags for the hash identifier!");for(y of l){if(!["string","number"].includes(typeof y))throw new Error("Tags must be of type string or number!");u.addTag(y)}}else i.useDefaultHandler&&u.addComponent(o.getDefaultDeserializer(i.fallbackHandler)(d,l));c.push(u)}return{entities:c.values()}}getRegisteredTypeHandlers(){return this.typeHandlers.entries()}registerTypeHandler(e,t,r){if(this.typeHandlers.has(e.name))throw new Error(`The type "${e.name}" was already registered!`);this.typeHandlers.set(e.name,{deserializer:t,serializer:r})}serialize(e,t){var r,s;const a={useDefaultHandler:null===(r=null==t?void 0:t.useDefaultHandler)||void 0===r||r,useRegisteredHandlers:null===(s=null==t?void 0:t.useRegisteredHandlers)||void 0===s||s,fallbackHandler:null==t?void 0:t.fallbackHandler},c=new i.SerialFormat;let u,l,d,h,y;for(l of e.entities){for(u of(h={},l.getComponents()))a.useRegisteredHandlers&&this.typeHandlers.has(u.constructor.name)?d=this.typeHandlers.get(u.constructor.name).serializer(u):a.useDefaultHandler&&(d=o.getDefaultSerializer(a.fallbackHandler)(u)),h[u.constructor.name]=d,d=void 0;y=Array.from(l.getTags()),y.length>0&&(h[n.CTagMarker]=y),c.push(h)}return c}}},2568:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CTagMarker=void 0,t.CTagMarker="#Tags"},9297:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SerialFormat=void 0,r(4107).__exportStar(r(6421),t);class s extends Array{static fromArray(e){return(new s).fromArray(e)}static fromJSON(e){return(new s).fromJSON(e)}fromArray(e){return Object.assign(this,e),this}fromJSON(e){this.length=0;const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("Input JSON must be an array!");for(const e of t)this.push(e);return this}toJSON(e){return JSON.stringify(Array.from(this),void 0,e)}}t.SerialFormat=s},6421:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},8966:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.State=void 0,r(4107).__exportStar(r(9147),t),t.State=class{constructor(e=[]){this._systems=e}get systems(){return this._systems}activate(e){}create(e){}deactivate(e){}destroy(e){}}},9147:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},3247:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.System=void 0,r(4107).__exportStar(r(143),t),t.System=class{destroy(e){}setup(e){}}},143:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},875:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t._=t.WorldBuilder=void 0;const s=r(1662),n=r(1634);function i(e,t){if("object"!=typeof t)throw new Error(`Cannot default-deserialize ${e.name}, because the data is of type ${typeof t}!`);const r=new e;for(const e of Object.entries(t))r[e[0]]=e[1];return r}function o(e){return e}t.WorldBuilder=class{constructor(e){this.ecs=e,this.callbacks=new Set,this.serde=new n.SerDe,this.systemInfos=new Map}addCallback(e){return this.callbacks.add(e),this}build(){const e=new s.World(this.ecs,new Set(this.systemInfos.values()),this.serde);for(const t of this.callbacks)t(e);return e}withSystem(e,t){if(this.systemInfos.has(e))throw new Error(`The system ${e.constructor.name} is already registered!`);return this.systemInfos.set(e,{system:new e,dependencies:new Set(t)}),this}withComponent(e,t){var r,s,n,a;return this.serde.registerTypeHandler(e,null!==(s=null===(r=null==t?void 0:t.serDe)||void 0===r?void 0:r.deserializer)&&void 0!==s?s:i.bind(void 0,e),null!==(a=null===(n=null==t?void 0:t.serDe)||void 0===n?void 0:n.serializer)&&void 0!==a?a:o),this}withComponents(...e){for(const t of e)this.withComponent(t);return this}},t._={dataStructDeserializer:i,dataStructSerializer:o}},1662:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.World=void 0;const s=r(4107),n=r(646),i=r(4429),o=r(8966),a=r(6680),c=r(1634),u=r(9443),l=r(3599),d=r(433);s.__exportStar(r(5027),t),t.World=class{constructor(e,t=new Set,r=new c.SerDe){this.ecs=e,this.systemInfos=t,this._serde=r,this._dirty=!1,this.entities=new Set,this.pda=new a.PushDownAutomaton,this.groups={nextHandle:0,entityLinks:new Map},this.queries=[],this.resources=new Map,this.runExecutionPipeline=[],this.runExecutionPipelineCache=new Map,this.runPromise=void 0,this.shouldRunSystems=!1;const s=this;this._commandsAggregator=new l.CommandsAggregator(this),this._commands=new u.Commands(this,this._commandsAggregator),this.systemWorld=Object.freeze({get commands(){return s._commands},get currentState(){return s.pda.state},getEntities:this.getEntities.bind(this),getResource:this.getResource.bind(this)}),this.transitionWorld=Object.freeze({get commands(){return s._commands},get currentState(){return s.pda.state},get serde(){return s.serde},buildEntity:this.buildEntity.bind(this),flushCommands:this.flushCommands.bind(this),getEntities:this.getEntities.bind(this),getResource:this.getResource.bind(this),getResources:this.getResources.bind(this),maintain:this.maintain.bind(this),save:this.save.bind(this)}),this.sortedSystems=this.sortSystems(this.systemInfos);for(const e of this.systemInfos)e.system.query&&this.queries.push(e.system.query)}get commands(){return this._commands}get dirty(){return this._dirty}get running(){return this.shouldRunSystems}get serde(){return this._serde}addEntity(e){this.entities.has(e)||(this.entities.add(e),this._dirty=!0)}addResource(e,...t){let r,s;if("object"==typeof e?(r=e.constructor,s=e):(r=e,s=new(e.prototype.constructor.bind(e,...Array.from(arguments).slice(1)))),this.resources.has(r))throw new Error(`Resource with name "${r.name}" already exists!`);return this.resources.set(r,s),s}buildEntity(){return new i.EntityBuilder}clearEntities(){this.entities.clear()}createEntity(){const e=new n.Entity;return this.entities.add(e),this._dirty=!0,e}async dispatch(e){await this.run({initialState:e,afterStepHandler:e=>e.commands.stopRun()})}flushCommands(){return this._commandsAggregator.executeAll()}getEntities(e){if(!e)return this.entities.keys();const t=new Set;let r;for(r of this.entities.keys())e.matchesEntity(r)&&t.add(r);return t.values()}getResource(e){if(!this.resources.has(e))throw new Error(`Resource of type "${e.name}" does not exist!`);return this.resources.get(e)}getResources(){return this.resources.values()}load(e,t,r){const s=[],n=null!=r?r:this.groups.nextHandle++;let i;for(i of this._serde.deserialize(e,t).entities)this.addEntity(i),s.push(i);return this.groups.entityLinks.set(n,s),n}maintain(){let e;for(e of this.queries)e[d.setEntitiesSym](this.entities.values());this._dirty=!1}merge(e,t){const r=null!=t?t:this.groups.nextHandle++,s=[];let n;for(n of e.getEntities())this.addEntity(n),s.push(n);return[r,s]}async popState(){var e,t;await(null===(e=this.pda.pop())||void 0===e?void 0:e.deactivate(this.transitionWorld));const r=this.pda.state;r?(await r.activate(this.transitionWorld),this.runExecutionPipeline=null!==(t=this.runExecutionPipelineCache.get(r.constructor))&&void 0!==t?t:[]):this.runExecutionPipeline=[]}prepareExecutionPipeline(e){const t=[],r=e.systems;let s,n,i=new Set;for(n of(0==this.sortedSystems.size&&this.sortSystems(this.systemInfos),this.sortedSystems))s=!!r.find((e=>e.prototype.constructor.name===n.system.constructor.name)),s&&(n.dependencies.size>0&&(t.push(i),i=new Set),i.add(n.system));return t.push(i),t}async pushState(e){var t,r;await(null===(t=this.pda.state)||void 0===t?void 0:t.deactivate(this.transitionWorld)),this.pda.push(e);const s=this.pda.state,n=Array.from(this.systemInfos).map((e=>e.system.constructor.name));for(const e of s.systems)if(!n.includes(e.name))throw new Error(`Did you forget to register System ${e.name}?`);this.runExecutionPipelineCache.has(e)?this.runExecutionPipeline=null!==(r=this.runExecutionPipelineCache.get(e))&&void 0!==r?r:[]:(s.create(this.transitionWorld),this.runExecutionPipeline=this.prepareExecutionPipeline(s),this.runExecutionPipelineCache.set(e,this.runExecutionPipeline)),await s.activate(this.transitionWorld)}async prepareRun(e){var t,r,s;if(this.runPromise)throw new Error("The dispatch loop is already running!");this._dirty&&this.maintain(),e||(e={});const n=e.initialState?e.initialState:o.State.bind(void 0,Array.from(this.systemInfos.values()).map((e=>e.system.constructor))),i={afterStepHandler:null!==(t=e.afterStepHandler)&&void 0!==t?t:e=>{},beforeStepHandler:null!==(r=e.beforeStepHandler)&&void 0!==r?r:e=>{},executionFunction:null!==(s=e.executionFunction)&&void 0!==s?s:"function"==typeof requestAnimationFrame?requestAnimationFrame:setTimeout,initialState:n};this.pda.clear(),this.shouldRunSystems=!0;for(const e of this.systemInfos)await e.system.setup(this.systemWorld);return await this.pushState(n),this.runExecutionPipeline=this.prepareExecutionPipeline(this.pda.state),this.lastRunPreparation=i,i}removeEntity(e){this.entities.delete(e),this._dirty=!0}removeEntityFromSystems(e){this.removeEntity(e),this.maintain()}replaceEntitiesWith(e){this.clearEntities(),this.merge(e)}replaceResource(e,...t){let r;if(r="object"==typeof e?e.constructor:e,!this.resources.has(r))throw new Error(`Resource with name "${r.name}" does not exists!`);this.resources.delete(r),this.addResource(e,...t)}removeResource(e){if(!this.resources.has(e))throw new Error(`Resource with name "${e.name}" does not exists!`);this.resources.delete(e)}run(e,t=!1){const r=new Promise((async s=>{let n;if(await this._commandsAggregator.executeAll(),n=t?this.lastRunPreparation:await this.prepareRun(e),!n)throw new Error("Cannot run without preparing the run!");this.runPromise=r;const i=n.afterStepHandler,o=n.beforeStepHandler,a=n.executionFunction;let c;const u=async()=>{var e;await(null===(e=this.pda.state)||void 0===e?void 0:e.deactivate(this.transitionWorld));for(let e=this.pda.pop();e;e=this.pda.pop())await e.destroy(this.transitionWorld);for(const e of this.systemInfos)await e.system.destroy(this.systemWorld);this.runExecutionPipelineCache.clear(),this.runPromise=void 0,s()},l=async()=>{if(this.shouldRunSystems){await o(this.transitionWorld);{let e,t;for(e of this.runExecutionPipeline){for(t of(c=[],e))c.push(t.run(this.systemWorld));await Promise.all(c)}}await i(this.transitionWorld),await this._commandsAggregator.executeAll(),a(l)}else await u()};a(l)}));return r}sortSystems(e){const t=Array.from(e),r=new Map(t.map((e=>[e.system.constructor,Array.from(e.dependencies)])));let s;const n=[],i=Array.from(r.entries()).filter((e=>0===e[1].length)).map((e=>e[0]));let o,a;for(;i.length>0;){o=i.shift(),n.push(o);for(let e of Array.from(r.entries()).filter((e=>e[1].includes(o))).map((e=>e[0])))s=r.get(e),s.splice(s.indexOf(o),1),s.length<=0&&i.push(e)}if(Array.from(r.values()).find((e=>e.length>0)))throw new Error("The system dependency graph is cyclic!");return new Set(n.map((e=>{if(a=t.find((t=>t.system.constructor==e)),!a)throw new Error(`The system ${e.name} was not registered!`);return a})))}stopRun(){this.shouldRunSystems=!1}save(e,t){return this.serde.serialize({entities:this.getEntities(e)},t)}unloadPrefab(e){if(!this.groups.entityLinks.has(e))throw new Error(`Could not find any loaded prefab under handle "${e}"!`);let t;for(t of this.groups.entityLinks.get(e))this.removeEntity(t);this.groups.entityLinks.delete(e)}}},5027:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},4107:(e,t,r)=>{r.r(t),r.d(t,{__extends:()=>n,__assign:()=>i,__rest:()=>o,__decorate:()=>a,__param:()=>c,__metadata:()=>u,__awaiter:()=>l,__generator:()=>d,__createBinding:()=>h,__exportStar:()=>y,__values:()=>f,__read:()=>p,__spread:()=>m,__spreadArrays:()=>g,__spreadArray:()=>w,__await:()=>v,__asyncGenerator:()=>_,__asyncDelegator:()=>b,__asyncValues:()=>S,__makeTemplateObject:()=>E,__importStar:()=>T,__importDefault:()=>O,__classPrivateFieldGet:()=>P,__classPrivateFieldSet:()=>C});var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var i=function(){return(i=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function o(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(r[s[n]]=e[s[n]])}return r}function a(e,t,r,s){var n,i=arguments.length,o=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(i<3?n(o):i>3?n(t,r,o):n(t,r))||o);return i>3&&o&&Object.defineProperty(t,r,o),o}function c(e,t){return function(r,s){t(r,s,e)}}function u(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function l(e,t,r,s){return new(r||(r=Promise))((function(n,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))}function d(e,t){var r,s,n,i,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,s&&(n=2&i[0]?s.return:i[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,i[1])).done)return n;switch(s=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,s=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!((n=(n=o.trys).length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){o.label=i[1];break}if(6===i[0]&&o.label<n[1]){o.label=n[1],n=i;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(i);break}n[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],s=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var h=Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]};function y(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||h(t,e,r)}function f(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],s=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var s,n,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=i.next()).done;)o.push(s.value)}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return o}function m(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}function g(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var s=Array(e),n=0;for(t=0;t<r;t++)for(var i=arguments[t],o=0,a=i.length;o<a;o++,n++)s[n]=i[o];return s}function w(e,t,r){if(r||2===arguments.length)for(var s,n=0,i=t.length;n<i;n++)!s&&n in t||(s||(s=Array.prototype.slice.call(t,0,n)),s[n]=t[n]);return e.concat(s||t)}function v(e){return this instanceof v?(this.v=e,this):new v(e)}function _(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,n=r.apply(e,t||[]),i=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(e){n[e]&&(s[e]=function(t){return new Promise((function(r,s){i.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=n[e](t)).value instanceof v?Promise.resolve(r.value.v).then(c,u):l(i[0][2],r)}catch(e){l(i[0][3],e)}var r}function c(e){a("next",e)}function u(e){a("throw",e)}function l(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}}function b(e){var t,r;return t={},s("next"),s("throw",(function(e){throw e})),s("return"),t[Symbol.iterator]=function(){return this},t;function s(s,n){t[s]=e[s]?function(t){return(r=!r)?{value:v(e[s](t)),done:"return"===s}:n?n(t):t}:n}}function S(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=f(e),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(r){t[r]=e[r]&&function(t){return new Promise((function(s,n){!function(e,t,r,s){Promise.resolve(s).then((function(t){e({value:t,done:r})}),t)}(s,n,(t=e[r](t)).done,t.value)}))}}}function E(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var x=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};function T(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&h(t,e,r);return x(t,e),t}function O(e){return e&&e.__esModule?e:{default:e}}function P(e,t,r,s){if("a"===r&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?s:"a"===r?s.call(e):s?s.value:t.get(e)}function C(e,t,r,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(e,r):n?n.value=r:t.set(e,r),r}}}]);
//# sourceMappingURL=895.js.map